name: Pipeline - Implement Fix

on:
  workflow_call:
    inputs:
      issue_number:
        required: true
        type: string

  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to implement fix for'
        required: true
        type: string

  issues:
    types: [labeled]

jobs:
  implement:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_call' || github.event_name == 'workflow_dispatch' || github.event.label.name == 'pipeline:implement'

    permissions:
      contents: write
      issues: write
      pull-requests: write

    outputs:
      pr_number: ${{ steps.create-pr.outputs.pr_number }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Determine issue number
        id: get-issue
        run: |
          if [ "${{ github.event_name }}" = "issues" ]; then
            echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          else
            echo "issue_number=${{ inputs.issue_number }}" >> $GITHUB_OUTPUT
          fi

      - name: Get fix design
        id: design
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DESIGN=$(gh issue view ${{ steps.get-issue.outputs.issue_number }} --comments --json comments \
            | jq -r '.comments[] | select(.body | contains("Fix Design")) | .body' \
            | head -1)

          echo "design<<EOF" >> $GITHUB_OUTPUT
          echo "$DESIGN" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create fix branch
        run: |
          BRANCH_NAME="fix/issue-${{ steps.get-issue.outputs.issue_number }}"
          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Run Implementer Agent
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          npx @anthropic-ai/claude-code --print \
            --system-prompt "$(cat agents/pipeline/implementer.md)" \
            "Implement the fix specified in this design document:

             ${{ steps.design.outputs.design }}

             Follow the implementation instructions exactly.
             Make the specified code changes.
             Do NOT make any changes beyond what is specified."

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes made by agent"
            exit 1
          fi

          git add -A
          git commit -m "fix: resolve issue #${{ steps.get-issue.outputs.issue_number }}

          Automated fix implemented by pipeline.

          Co-authored-by: Claude <noreply@anthropic.com>"

          git push -u origin "${{ env.branch_name }}"

      - name: Create Pull Request
        id: create-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_BODY="## Fix for Issue #${{ steps.get-issue.outputs.issue_number }}

          This PR was automatically generated by the fix pipeline.

          ### Related Issue
          Closes #${{ steps.get-issue.outputs.issue_number }}

          ### Changes Made
          See the fix design in the issue comments for details.

          ### Pipeline Status
          - [x] Investigation
          - [x] Fix Design
          - [x] Implementation
          - [ ] Testing
          - [ ] Knowledge Update

          ---
          *Automated PR - please review carefully before merging.*"

          PR_URL=$(gh pr create \
            --title "fix: resolve issue #${{ steps.get-issue.outputs.issue_number }}" \
            --body "$PR_BODY" \
            --label "pipeline:test")

          PR_NUMBER=$(echo $PR_URL | grep -oE '[0-9]+$')
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "Created PR #$PR_NUMBER"

      - name: Update issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMENT="## ðŸ”§ Implementation Complete

          Created PR #${{ steps.create-pr.outputs.pr_number }} with the fix.

          ---
          **Next step:** Tester agent will validate the fix.

          *Tests will run automatically on the PR.*"

          gh issue comment ${{ steps.get-issue.outputs.issue_number }} --body "$COMMENT"

          CURRENT_BODY=$(gh issue view ${{ steps.get-issue.outputs.issue_number }} --json body -q .body)
          UPDATED_BODY=$(echo "$CURRENT_BODY" | sed 's/- \[ \] Implementation/- [x] Implementation/')
          gh issue edit ${{ steps.get-issue.outputs.issue_number }} --body "$UPDATED_BODY"
