name: Pipeline - Implement Fix

on:
  workflow_call:
    inputs:
      issue_number:
        required: true
        type: string

  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to implement fix for'
        required: true
        type: string

  issues:
    types: [labeled]

jobs:
  implement:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_call' || github.event_name == 'workflow_dispatch' || github.event.label.name == 'pipeline:implement'

    permissions:
      contents: write
      issues: write
      pull-requests: write

    outputs:
      pr_number: ${{ steps.create-pr.outputs.pr_number }}
      issue_number: ${{ steps.get-issue.outputs.issue_number }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Determine issue number
        id: get-issue
        run: |
          if [ "${{ github.event_name }}" = "issues" ]; then
            echo "issue_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          else
            echo "issue_number=${{ inputs.issue_number }}" >> $GITHUB_OUTPUT
          fi

      - name: Get fix design
        id: design
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DESIGN=$(gh issue view ${{ steps.get-issue.outputs.issue_number }} --comments --json comments \
            | jq -r '.comments[] | select(.body | contains("Fix Design")) | .body' \
            | head -1)

          echo "design<<EOF" >> $GITHUB_OUTPUT
          echo "$DESIGN" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create fix branch
        run: |
          BRANCH_NAME="fix/issue-${{ steps.get-issue.outputs.issue_number }}"
          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_ENV

      - name: Run Implementer Agent
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get design from file to avoid shell escaping issues
          gh issue view ${{ steps.get-issue.outputs.issue_number }} --comments --json comments \
            | jq -r '.comments[] | select(.body | contains("Fix Design")) | .body' \
            | head -n 500 > /tmp/design.txt

          # Run claude-code in non-interactive mode with allowedTools
          npx @anthropic-ai/claude-code \
            --allowedTools "Edit,Read,Write,Glob,Grep,Bash" \
            --max-turns 15 \
            --system-prompt "$(cat agents/pipeline/implementer.md)" \
            -p "Implement the fix specified in this design document. First read /tmp/design.txt to understand the required changes. Then make the exact code changes specified. The design document contains the file paths and code changes needed. Follow the implementation instructions exactly. Do NOT make any changes beyond what is specified in the design."

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes made by agent"
            exit 1
          fi

          git add -A
          git commit -m "fix: resolve issue #${{ steps.get-issue.outputs.issue_number }}

          Automated fix implemented by pipeline.

          Co-authored-by: Claude <noreply@anthropic.com>"

          git push -u origin "${{ env.branch_name }}"

      - name: Create Pull Request
        id: create-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_BODY="## Fix for Issue #${{ steps.get-issue.outputs.issue_number }}

          This PR was automatically generated by the fix pipeline.

          ### Related Issue
          Closes #${{ steps.get-issue.outputs.issue_number }}

          ### Changes Made
          See the fix design in the issue comments for details.

          ### Pipeline Status
          - [x] Investigation
          - [x] Fix Design
          - [x] Implementation
          - [ ] Testing
          - [ ] Knowledge Update

          ---
          *Automated PR - please review carefully before merging.*"

          PR_URL=$(gh pr create \
            --title "fix: resolve issue #${{ steps.get-issue.outputs.issue_number }}" \
            --body "$PR_BODY" \
            --label "pipeline:test")

          PR_NUMBER=$(echo $PR_URL | grep -oE '[0-9]+$')
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "Created PR #$PR_NUMBER"

      - name: Update issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMENT="## ðŸ”§ Implementation Complete

          Created PR #${{ steps.create-pr.outputs.pr_number }} with the fix.

          ---
          **Next step:** Tester agent will validate the fix.

          *Tests will run automatically on the PR.*"

          gh issue comment ${{ steps.get-issue.outputs.issue_number }} --body "$COMMENT"

          CURRENT_BODY=$(gh issue view ${{ steps.get-issue.outputs.issue_number }} --json body -q .body)
          UPDATED_BODY=$(echo "$CURRENT_BODY" | sed 's/- \[ \] Implementation/- [x] Implementation/')
          gh issue edit ${{ steps.get-issue.outputs.issue_number }} --body "$UPDATED_BODY"

  # Auto-trigger test phase (fully autonomous mode)
  trigger-test:
    needs: implement
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Trigger test workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh workflow run "Pipeline - Test Fix" \
            --repo ${{ github.repository }} \
            -f pr_number="${{ needs.implement.outputs.pr_number }}"
