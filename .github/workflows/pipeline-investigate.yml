name: Pipeline - Investigate

on:
  workflow_call:
    inputs:
      issue_number:
        required: true
        type: string

jobs:
  investigate:
    runs-on: ubuntu-latest
    outputs:
      issue_number: ${{ inputs.issue_number }}

    permissions:
      contents: read
      issues: write
      pull-requests: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git blame

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get issue details
        id: issue
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue view ${{ inputs.issue_number }} --json body > /tmp/issue.json
          ISSUE_BODY=$(cat /tmp/issue.json | jq -r '.body')
          echo "issue_body<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Run Investigator Agent
        id: investigate
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          REPORT=$(npx @anthropic-ai/claude-code --print \
            --system-prompt "$(cat agents/pipeline/investigator.md)" \
            "Investigate this error from issue #${{ inputs.issue_number }}:

             ${{ steps.issue.outputs.issue_body }}

             Follow the investigation process in your instructions.
             Use git blame, search the codebase, and trace to the originating PR.
             Output your findings as a structured report.")

          echo "$REPORT" > /tmp/investigation.md
          echo "report<<EOF" >> $GITHUB_OUTPUT
          echo "$REPORT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Update issue with investigation
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Build comment from file to avoid shell escaping issues
          {
            echo "## ðŸ” Investigation Report"
            echo ""
            cat /tmp/investigation.md
            echo ""
            echo "---"
            echo "**Next step:** Fix Designer agent will propose a solution."
            echo ""
            echo "*To proceed, add the label \`pipeline:design\` or comment \`/proceed\`*"
          } > /tmp/comment.md

          # Post comment using file input
          gh issue comment ${{ inputs.issue_number }} --body-file /tmp/comment.md

          # Update checklist
          gh issue view ${{ inputs.issue_number }} --json body -q .body > /tmp/current_body.txt
          sed 's/- \[ \] Investigation/- [x] Investigation/' /tmp/current_body.txt > /tmp/updated_body.txt
          gh issue edit ${{ inputs.issue_number }} --body-file /tmp/updated_body.txt

      - name: Save investigation state
        run: |
          mkdir -p .claude/pipeline/investigations
          cp /tmp/investigation.md .claude/pipeline/investigations/issue-${{ inputs.issue_number }}.md

  # Auto-trigger design phase (fully autonomous mode)
  trigger-design:
    needs: investigate
    runs-on: ubuntu-latest
    steps:
      - name: Trigger design workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh workflow run "Pipeline - Design Fix" \
            --repo ${{ github.repository }} \
            -f issue_number="${{ needs.investigate.outputs.issue_number }}"
